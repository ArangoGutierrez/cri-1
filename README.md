# Singularity CRI

<a href="https://app.zenhub.com/workspace/o/sylabs/cri/boards"><img src="https://raw.githubusercontent.com/ZenHubIO/support/master/zenhub-badge.png"></a>

This repository contains Singularity implementation of [Kubernetes CRI](https://github.com/kubernetes/community/blob/master/contributors/devel/container-runtime-interface.md). Singularity CRI consists of
two separate services: runtime and image, each of which implements K8s RuntimeService and ImageService respectively. 


The ImageService is currently under development and passes 4/6 [validation tests](https://github.com/kubernetes-sigs/cri-tools/blob/master/docs/validation.md).
 
## Quick Start

To work on Singularity CRI install the following:

- [git](https://git-scm.com/downloads)
- [go](https://golang.org/doc/install)
- [dep](https://golang.github.io/dep/docs/installation.html)

Make sure you configured [go workspace](https://golang.org/doc/code.html).

To set up project do the following:

```bash
$ go get https://github.com/sylabs/cri
$ cd $GOPATH/src/github.com/sylabs/cri
$ dep ensure
```
After this steps you can start working on the project.

Make sure to run linters before submitting PR:

```bash
make lint
``` 

## Running and testing

To build server and test binaries you can use Makefile:

```bash
make build
```

This will produce the following files: 
- sycri.out - CRI server 
- sycri.test.out - custom cli to test running CRI server
- sycri.runtime.test - compiled runtime service tests
- sycri.image.test  - compiled image service tests


To start CRI server simply run _sycri.out_ binary. By default CRI listens for requests on 
`unix:///var/run/singularity.sock` and stores image files at `/var/lib/singularity`. This behaviour may be configured
with flags, run `./sycri.out -h` for more details. 

##
To run unit tests simply execute test binaries:
```bash
./sycri.image.test
./sycri.runtime.test

```
## 
For live testing you can use `sycri.test.out`. **WARNING! This is a quickly made cli to test ImageService and is not
for production use.** To start interactive cli test tool run the executable and pass socket to connect to CRI:
```bash
./sycri.test.out unix:///var/run/singularity.sock
```

The following cammands are supported:
- `pull <image>` - pull image by tag or digest. To pull from library or shub specify `library://` or `shub://` prefix
before image respectively.
- `list` - list all available images
- `remove <iamge>` - remove image by tag, digest or ID
- `stat <image>` - get image info by tag, digest or ID
- `exit` - stop interactive cli

## Project Structure

```
- cmd/
    - server/            Singularity CRI server
    - test/            	 CLI to call Singularity CRI
- pkg/
    - image/        	 Image service implementation
    - runtime/           Runtime service implementation
    - singularity/       Common for services Singularity constants
- vendor/               Vendored dependencies (generated by dep)
- Gopkg.lock            Generated dependency graph (generated by dep)
- Gopkg.toml            Dependency rules (used by dep)
```

## Resources

* [How to Write Go Code](https://golang.org/doc/code.html)
* [Effective Go](https://golang.org/doc/effective_go.html)
* [Go Code Review Comments](https://github.com/golang/go/wiki/CodeReviewComments)
* [GitHub Flow](https://guides.github.com/introduction/flow/)
* [Standard Go Project Layout](https://github.com/golang-standards/project-layout)
